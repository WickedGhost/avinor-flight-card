name: Release Assets

on:
  release:
    types: [published]

jobs:
  release:
    name: Build and upload assets
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build distribution bundle
        run: npm run build

      - name: Validate version and required files
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Release tag must follow semantic versioning (v1.2.3)"
            exit 1
          fi
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "$VERSION" ]; then
            echo "package.json version ($PKG_VERSION) does not match tag ($VERSION)"
            exit 1
          fi
          for file in dist/avinor-flight-card.js hacs.json README.md LICENSE; do
            if [ ! -f "$file" ]; then
              echo "Required file $file is missing"
              exit 1
            fi
          done

      - name: Prepare release artifacts
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          mkdir -p release
          cp dist/avinor-flight-card.js release/avinor-flight-card.js
          cp README.md release/README.md
          cp LICENSE release/LICENSE
          ZIP_PATH="release/avinor-flight-card-${TAG_NAME}.zip"
          zip -jq "$ZIP_PATH" release/avinor-flight-card.js release/README.md release/LICENSE

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/avinor-flight-card.js
            release/avinor-flight-card-${{ github.ref_name }}.zip