name: Release

on:
  # Run when a GitHub release is published OR when a matching tag is pushed
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Prepare release
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "Lock file present, using npm ci";
            npm ci;
          else
            echo "No lock file, falling back to npm install";
            npm install;
          fi

      - name: Validate release
        run: |
          # Ensure the release tag matches expected format (v*.*.*)
          if [[ ! "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Release tag must follow semantic versioning (v1.0.0)"
            exit 1
          fi
          
          # Check that main files exist
          for file in "dist/avinor-flight-card.js" "hacs.json" "README.md"; do
            if [ ! -f "$file" ]; then
              echo "Required file $file is missing!"
              exit 1
            fi
          done

      - name: Inject version into distributed file
        run: |
          TAG="${{ github.ref_name }}"
          VERSION_NO_V="${TAG#v}"
          echo "Release tag: ${TAG} -> Version: ${VERSION_NO_V}"
          mkdir -p release
          # Replace __VERSION__ placeholder and write to release folder
          node -e "const fs=require('fs');let s=fs.readFileSync('dist/avinor-flight-card.js','utf8');s=s.replace(/__VERSION__/g,'${VERSION_NO_V}');fs.writeFileSync('release/avinor-flight-card.js',s);"

      - name: Build optional minified artifact
        run: |
          # Build a minified variant (does not replace main file)
          VERSION="${{ github.ref_name }}" npm run build
          
      - name: Create release artifacts
        run: |
          # Create a zip file with the main card file for easy installation
          cd release
          zip -r ../avinor-flight-card-${{ github.ref_name }}.zip avinor-flight-card.js ../README.md ../LICENSE
          cd -
          
      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./avinor-flight-card-${{ github.ref_name }}.zip
          asset_name: avinor-flight-card-${{ github.ref_name }}.zip
          asset_content_type: application/zip